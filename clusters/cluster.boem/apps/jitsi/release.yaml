apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: jitsi
  namespace: jitsi
spec:
  # install:
  #   remediation:
  #     retries: -1
  chart:
    spec:
      chart: jitsi-meet
      version: 1.5.2
      sourceRef:
        kind: HelmRepository
        name: jitsi
        namespace: flux-system
  postRenderers:
    - kustomize:
        patches:
          - target:
              version: v1
              kind: Service
              name: jitsi-jitsi-meet-jvb
            patch: |
              - op: remove
                path: /spec/externalTrafficPolicy
  # - patch: |-
  #     apiVersion: v1
  #     kind: Deployment
  #     metadata:
  #       name: jitsi-jitsi-meet-jvb
  #       namespace: jitsi
  #       labels:
  #         lb-pool: external
  #   target:
  #     name: jitsi-jitsi-meet-jvb
  #     kind: Service
  #     version: v1

  # - target:
  #     version: v1
  #     kind: Service
  #     name: jitsi-jitsi-meet-jvb
  #     namespace: jitsi
  #   patch: |
  #     - op: add
  #       path: /metadata/labels/lb-pool
  #       value: external
  interval: 24h
  values:
    enableAuth: false
    enableGuests: true
    publicURL: "meet.maishond.nl"
    tz: Europe/Amsterdam

    ## WebSocket configuration:
    #
    #  Both Colibri and XMPP WebSockets are disabled by default,
    #  since some LoadBalancer / Reverse Proxy setups can't pass
    #  WebSocket connections properly, which might result in breakage
    #  for some clients.
    #
    #  Enable both Colibri and XMPP WebSockets to replicate the current
    #  upstream `meet.jit.si` setup. Keep both disabled to replicate
    #  older setups which might be more compatible in some cases.
    websockets:
      ## Colibri (JVB signalling):
      colibri:
        enabled: true
      ## XMPP (Prosody signalling):
      xmpp:
        enabled: true

    jvb:
      publicIPs:
        - 45.83.205.8
        - 2a07:54c7:5201:6e6f::a
      useHostPort: false
      service:
        enabled: true
        # externalTrafficPolicy: Local

      # UDPPort: 32768
      # stunServers: >-
      # stun.l.google.com:19302,stun1.l.google.com:19302,stun2.l.google.com:19302,stun3.l.google.com:19302,stun4.l.google.com:19302
      # useHostPort: true
      # useNodeIP: true
      # UDPPort: 10000
      # service:
      #   enabled: true
      #   type: ClusterIP
      # nodePort: 10000
      # service:
      #   enabled: true
      #   type: LoadBalancer
      #   ipFamilyPolicy: RequireDualStack
      #   externalTrafficPolicy: Cluster
      #   annotations:
      #     lbipam.cilium.io/ips: "45.83.205.8,2a07:54c7:5201:6e6f::a"
      #     lbipam.cilium.io/sharing-key: "8-share"
      #     lbipam.cilium.io/sharing-cross-namespace: "*"
      # securityContext:
      #   capabilities:
      #     drop:
      #       - ALL
      #   allowPrivilegeEscalation: false
      # podSecurityContext:
      #   seccompProfile:
      #     type: RuntimeDefault

    web:
      replicaCount: 1
      # securityContext:
      #   capabilities:
      #     drop:
      #       - ALL
      #   allowPrivilegeEscalation: false
      # podSecurityContext:
      #   seccompProfile:
      #     type: RuntimeDefault

    jibri:
      # replicaCount: 3
      ## Enabling Jibri will allow users to record
      ## and/or stream their meetings (e.g. to YouTube).
      enabled: false # true

      ## Enable single-use mode for Jibri (recommended).
      singleUseMode: false

      ## Enable multiple Jibri instances.
      ## Secommended for single-use mode.
      replicaCount: 1

      ## Enable recording service.
      ## Set this to true/false to enable/disable local recordings.
      ## Defaults to enabled (allow local recordings).
      recording: true

      ## Enable livestreaming service.
      ## Set this to true/false to enable/disable live streams.
      ## Defaults to disabled (livestreaming is forbidden).
      livestreaming: true

      ## Enable persistent storage for local recordings.
      ## If disabled, jibri pod will use a transient
      ## emptyDir-backed storage instead.
      # persistence:
      #   enabled: true
      #   size: 32Gi

      shm:
        ## Set to true to enable "/dev/shm" mount.
        ## May be required by built-in Chromium.
        enabled: false # true

    prosody:
      ## Override the image-provided configuration files:
      #  See https://github.com/jitsi/docker-jitsi-meet/tree/master/prosody/rootfs
      # custom:
      # contInit:
      #   _10_config: ""
      # defaults:
      # _prosody_cfg_lua: ""
      # _saslauthd_conf: ""
      _jitsi_meet_cfg_lua: |
        admins = {
            "focus@auth.meet.jitsi",
            "jvb@auth.meet.jitsi"
        }

        unlimited_jids = {
            "focus@auth.meet.jitsi",
            "jvb@auth.meet.jitsi"
        }

        plugin_paths = { "/prosody-plugins/", "/prosody-plugins-custom", "/prosody-plugins-contrib" }

        muc_mapper_domain_base = "meet.jitsi";
        muc_mapper_domain_prefix = "muc";

        recorder_prefixes = { "recorder@hidden.meet.jitsi" };

        http_default_host = "meet.jitsi"

        consider_bosh_secure = true;
        consider_websocket_secure = true;

        smacks_max_unacked_stanzas = 5;
        smacks_hibernation_time = 60;
        smacks_max_old_sessions = 1;

        VirtualHost "meet.jitsi"

            authentication = "jitsi-anonymous"

            ssl = {
                key = "/config/certs/meet.jitsi.key";
                certificate = "/config/certs/meet.jitsi.crt";
            }
            modules_enabled = {
                "bosh";
                "features_identity";

                "websocket";
                "smacks"; -- XEP-0198: Stream Management

                "conference_duration";

                "muc_lobby_rooms";

                "muc_breakout_rooms";

                "muc_size";
            }

            main_muc = "muc.meet.jitsi"

            lobby_muc = "lobby.meet.jitsi"

            breakout_rooms_muc = "breakout.meet.jitsi"

            c2s_require_encryption = true

        VirtualHost "auth.meet.jitsi"
            ssl = {
                key = "/config/certs/auth.meet.jitsi.key";
                certificate = "/config/certs/auth.meet.jitsi.crt";
            }
            modules_enabled = {
                "limits_exception";
                "smacks";
            }
            authentication = "internal_hashed"
            smacks_hibernation_time = 15;

        Component "internal-muc.meet.jitsi" "muc"
            storage = "memory"
            modules_enabled = {
                "muc_hide_all";
                "muc_filter_access";
                }
            restrict_room_creation = true
            muc_filter_whitelist="auth.meet.jitsi"
            muc_room_locking = false
            muc_room_default_public_jids = true
            muc_room_cache_size = 1000
            muc_tombstones = false
            muc_room_allow_persistent = false

        Component "muc.meet.jitsi" "muc"
            restrict_room_creation = true
            storage = "memory"
            modules_enabled = {
                "muc_hide_all";
                "muc_meeting_id";

                "muc_domain_mapper";

                "muc_password_whitelist";

            }

            -- The size of the cache that saves state for IP addresses
            rate_limit_cache_size = 10000;

            muc_room_cache_size = 10000
            muc_room_locking = false
            muc_room_default_public_jids = true

            muc_password_whitelist = {
                "focus@auth.meet.jitsi";
            }
            muc_tombstones = false
            muc_room_allow_persistent = false

        Component "focus.meet.jitsi" "client_proxy"
            target_address = "focus@auth.meet.jitsi"

        Component "speakerstats.meet.jitsi" "speakerstats_component"
            muc_component = "muc.meet.jitsi"


        Component "endconference.meet.jitsi" "end_conference"
            muc_component = "muc.meet.jitsi"



        Component "avmoderation.meet.jitsi" "av_moderation_component"
            muc_component = "muc.meet.jitsi"



        Component "lobby.meet.jitsi" "muc"
            storage = "memory"
            restrict_room_creation = true
            muc_tombstones = false
            muc_room_allow_persistent = false
            muc_room_cache_size = 10000
            muc_room_locking = false
            muc_room_default_public_jids = true
            modules_enabled = {
                "muc_hide_all";
            }




        Component "breakout.meet.jitsi" "muc"
            storage = "memory"
            restrict_room_creation = true
            muc_room_cache_size = 10000
            muc_room_locking = false
            muc_room_default_public_jids = true
            muc_tombstones = false
            muc_room_allow_persistent = false
            modules_enabled = {
                "muc_hide_all";
                "muc_meeting_id";
                }


        Component "metadata.meet.jitsi" "room_metadata_component"
            muc_component = "muc.meet.jitsi"
            breakout_rooms_component = "breakout.meet.jitsi"




        Component "polls.meet.jitsi" "polls_component"
      # extraVolumes:
      #   - name: prosody-modules
      #     configMap:
      #       name: prosody-modules
      # extraVolumeMounts:
      #   - name: prosody-modules
      #     subPath: muc-mod.cfg.lua
      #     mountPath: /config/conf.d/muc-mod.cfg.lua

    # jigasi:
    #   securityContext:
    #     capabilities:
    #       drop:
    #         - ALL
    #     allowPrivilegeEscalation: false
    #   podSecurityContext:
    #     seccompProfile:
    #       type: RuntimeDefault

    # jicofo:
    #   securityContext:
    #     capabilities:
    #       drop:
    #         - ALL
    #     allowPrivilegeEscalation: false
    #   podSecurityContext:
    #     seccompProfile:
    #       type: RuntimeDefault
