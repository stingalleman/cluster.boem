apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nameserver
  namespace: dns
spec:
  chart:
    spec:
      version: 1.45.0
      chart: coredns
      sourceRef:
        kind: HelmRepository
        name: coredns
        namespace: flux-system
  interval: 24h
  values:
    replicaCount: 2
    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 128Mi

    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 25%

    prometheus:
      service:
        enabled: false
        annotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "9153"
        selector: {}
      monitor:
        enabled: false
        additionalLabels: {}
        namespace: ""
        interval: ""
        selector: {}

    # isClusterService specifies whether chart should be deployed as cluster-service or normal k8s app.
    isClusterService: false

    # Default zone is what Kubernetes recommends:
    # https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/#coredns-configmap-options
    servers:
      - zones:
          - zone: .
            use_tcp: true
        port: 53
        # -- expose the service on a different port
        # servicePort: 5353
        # If serviceType is nodePort you can specify nodePort here
        # nodePort: 30053
        # hostPort: 53
        plugins:
          - name: errors
          # Serves a /health endpoint on :8080, required for livenessProbe
          - name: health
            configBlock: |-
              lameduck 10s
          # Serves a /ready endpoint on :8181, required for readinessProbe
          - name: ready
          # Serves a /metrics endpoint on :9153, required for serviceMonitor
          - name: root /etc/coredns
          - name: auto
            configBlock: |-
              directory /etc/coredns
          - name: prometheus
            parameters: 0.0.0.0:9153
          - name: cache
            parameters: 30
          - name: loop
          - name: reload
          - name: loadbalance

    # Extra configuration that is applied outside of the default zone block.
    # Example to include additional config files, which may come from extraVolumes:
    # extraConfig:
    #   import:
    #     parameters: /opt/coredns/*.conf
    extraConfig: {}

    # configure custom zone files as per https://coredns.io/2017/05/08/custom-dns-entries-for-kubernetes/
    zoneFiles:
      - filename: db.stingalleman.nl
        domain: stingalleman.nl
        contents: |
          $ORIGIN .
          stingalleman.nl 3600 IN A 45.83.205.8
          stingalleman.nl 3600 IN SOA ns1.as216455.net. noc.as216455.net. 2025091906 7200 3600 86400 2419200
