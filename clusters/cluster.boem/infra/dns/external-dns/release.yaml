apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nameserver
  namespace: dns
spec:
  chart:
    spec:
      version: 1.19.0
      chart: external-dns
      sourceRef:
        kind: HelmRepository
        name: external-dns
        namespace: flux-system
  interval: 24h
  values:
    serviceMonitor:
      # -- If `true`, create a `ServiceMonitor` resource to support the _Prometheus Operator_.
      enabled: false
      # -- Additional labels for the `ServiceMonitor`.
      additionalLabels: {}
      # -- Annotations to add to the `ServiceMonitor`.
      annotations: {}
      # -- (string) If set create the `ServiceMonitor` in an alternate namespace.
      namespace: # @schema type:[string, null]; default: null
      # -- (string) If set override the _Prometheus_ default interval.
      interval: # @schema type:[string, null]; default: null
      # -- (string) If set override the _Prometheus_ default scrape timeout.
      scrapeTimeout: # @schema type:[string, null]; default: null
      # -- (string) If set overrides the _Prometheus_ default scheme.
      scheme: # @schema type:[string, null]; default: null
      # -- Configure the `ServiceMonitor` [TLS config](https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#tlsconfig).
      tlsConfig: {}
      # -- (string) Provide a bearer token file for the `ServiceMonitor`.
      bearerTokenFile: # @schema type:[string, null]; default: null
      # -- [Relabel configs](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config) to apply to samples before ingestion.
      relabelings: []
      # -- [Metric relabel configs](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#metric_relabel_configs) to apply to samples before ingestion.
      metricRelabelings: []
      # -- Provide target labels for the `ServiceMonitor`.
      targetLabels: []

    # -- Log level.
    logLevel: info # @schema enum:[panic, debug, info, warning, error, fatal]; type:string; default: "info"

    # -- Log format.
    logFormat: text # @schema enum:["text", "json"]; type:string; default: "text"

    # -- Interval for DNS updates.
    interval: 1m

    # -- _Kubernetes_ resources to monitor for DNS entries.
    sources:
      - service
      - ingress

    # -- How DNS records are synchronized between sources and providers; available values are `create-only`, `sync`, & `upsert-only`.
    policy: upsert-only # @schema enum:[create-only, sync, upsert-only]; type:string; default: "upsert-only"

    # -- Specify the registry for storing ownership and labels.
    # Valid values are `txt`, `aws-sd`, `dynamodb` & `noop`.
    registry: txt # @schema enum:[txt, aws-sd, dynamodb, noop]; default: "txt"
    # -- (string) Specify an identifier for this instance of _ExternalDNS_ when using a registry other than `noop`.
    txtOwnerId: # @schema type:[string, null]; default: null
    # -- (string) Specify a prefix for the domain names of TXT records created for the `txt` registry.
    # Mutually exclusive with `txtSuffix`.
    txtPrefix: # @schema type:[string, null]; default: null
    # -- (string) Specify a suffix for the domain names of TXT records created for the `txt` registry.
    # Mutually exclusive with `txtPrefix`.
    txtSuffix: # @schema type:[string, null]; default: null

    # -- Limit possible target zones by domain suffixes.
    domainFilters: []

    # -- Intentionally exclude domains from being managed.
    excludeDomains: []

    # -- Filter resources queried for endpoints by label selector.
    labelFilter: # @schema type: [string,null]; default: null

    # -- Filter resources queried for endpoints by annotation selector.
    annotationFilter: # @schema type: [string,null]; default: null

    # -- Record types to manage (default: A, AAAA, CNAME)
    managedRecordTypes: [] # @schema type: [array, null]; item: string; uniqueItems: true

    provider: # @schema type: [object, string]
      # -- _ExternalDNS_ provider name; for the available providers and how to configure them see [README](https://github.com/kubernetes-sigs/external-dns/blob/master/charts/external-dns/README.md#providers).
      name: aws
      webhook:
        image:
          # -- (string) Image repository for the `webhook` container.
          repository: # @schema type:[string, null]; default: null
          # -- (string) Image tag for the `webhook` container.
          tag: # @schema type:[string, null]; default: null
          # -- Image pull policy for the `webhook` container.
          pullPolicy: IfNotPresent
        # -- [Environment variables](https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/) for the `webhook` container.
        env: []
        # -- Extra arguments to provide for the `webhook` container.
        args: []
        # -- Extra [volume mounts](https://kubernetes.io/docs/concepts/storage/volumes/) for the `webhook` container.
        extraVolumeMounts: []
        # -- [Resources](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) for the `webhook` container.
        resources: {}
        # -- [Pod security context](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-container) for the `webhook` container.
        # @default -- See _values.yaml_
        securityContext: {}
        # -- [Liveness probe](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/) configuration for the `external-dns` container.
        # @default -- See _values.yaml_
        livenessProbe:
          httpGet:
            path: /healthz # @schema type:[string, null]; default: null
            port: http-webhook # @schema type:[integer,string]; default: string
          initialDelaySeconds: 10 # @schema type:[integer, null]; default: null
          periodSeconds: 10 # @schema type:[integer, null]; default: null
          timeoutSeconds: 5 # @schema type:[integer, null]; default: null
          failureThreshold: 2 # @schema type:[integer, null]; default: null
          successThreshold: 1 # @schema type:[integer, null]; default: null
        # -- [Readiness probe](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/) configuration for the `webhook` container.
        # @default -- See _values.yaml_
        readinessProbe:
          httpGet:
            path: /healthz # @schema type:[string, null]; default: null
            port: http-webhook # @schema type:[integer,string]; default: string
          initialDelaySeconds: 5 # @schema type:[integer, null]; default: null
          periodSeconds: 10 # @schema type:[integer, null]; default: null
          timeoutSeconds: 5 # @schema type:[integer, null]; default: null
          failureThreshold: 6 # @schema type:[integer, null]; default: null
          successThreshold: 1 # @schema type:[integer, null]; default: null
        service:
          # -- Webhook exposed HTTP port for the service.
          port: 8080
        # -- Optional [Service Monitor](https://prometheus-operator.dev/docs/operator/design/#servicemonitor) configuration for the `webhook` container.
        # @default -- See _values.yaml_
        serviceMonitor:
          interval:
          scheme:
          tlsConfig: {}
          bearerTokenFile:
          scrapeTimeout:
          metricRelabelings: []
          relabelings: []
