#jinja2: lstrip_blocks:True
{% for peer in peers %}
	{% for neighbor in peer.neighbors %}
		{% set ns = namespace(found_ix=none, neighbor_name=none, inet=none, peer_type=peer.type | default("peer"), local_pref=0, description=none) %}
		{% if neighbor.ip | ansible.utils.ipv6 %}
			{% set ns.inet = "INET6" %}
		{% elif neighbor.ip | ansible.utils.ipv4 %}
			{% set ns.inet = "INET4" %}
		{% endif %}
		{% set neighbor_id = neighbor.id | default(1) | string %}
		{% for ix_name, ix_config in ix.items() %}
			{% for prefix in ix_config.prefixes if ns.found_ix is none %}
				{% if neighbor.ip | ansible.utils.ipaddr(prefix) is not none and ns.found_ix is none %}
					{% set ns.found_ix = ix_name %}
					{% if ns.peer_type == "routeserver" %}
						{% set ns.neighbor_name = "IXP_RS_" + ix_name.upper() + "_" + neighbor_id + "_" + ns.inet %}
						{% set ns.description = peer.name + " - AS" + peer.as | string + " (" + ns.peer_type + ", " + ix_name + ")"%}
						{% set ns.local_pref = types.routeserver.local_pref %}
					{% else %}
						{% set ns.neighbor_name = "IXP_" + ix_name.upper() + "_AS" + peer.as | string + "_" + neighbor_id + "_" + ns.inet %}
						{% set ns.description = peer.name + " - AS" + peer.as | string + " (" + ns.peer_type + ", " + ix_name + ")"%}
						{% set ns.peer_type = "ixp_peer" %}
						{% set ns.local_pref = ix_config.local_pref %}
					{% endif %}
				{% endif %}
			{% endfor %}
			{# if no ixp found #}
			{% if ns.found_ix is none %}
				{% if ns.peer_type == "transit" %}
						{% set ns.neighbor_name = "TRANSIT_AS" + peer.as | string + "_" + neighbor_id + "_" + ns.inet %}
						{% set ns.local_pref = types.transit.local_pref %}
				{% elif ns.peer_type == "customer" %}
						{% set ns.neighbor_name = "CUST_AS" + peer.as | string + "_" + neighbor_id + "_" + ns.inet %}
						{% set ns.local_pref = types.customer.local_pref %}
				{% else %}
						{% set ns.neighbor_name = "AS" + peer.as | string + "_" + neighbor_id + "_" + ns.inet %}
						{% set ns.local_pref = types.peer.local_pref %}
				{% endif %}
			{% endif %}
		{% endfor %}
		{% if neighbor.local_pref is defined %}
			{% set ns.local_pref = neighbor.local_pref %}
		{% elif peer.local_pref is defined %}
			{% set ns.local_pref = peer.local_pref %}
		{% endif %}
		{% if ns.description is none %}
			{% set ns.description = peer.name + " - AS" + peer.as | string + " (" + ns.peer_type + ")"%}
		{% endif %}
# {{ ns.description }}
protocol bgp {{ ns.neighbor_name }} {
	local as {{ local_as }};
	neighbor {{ neighbor.ip }} as {{ peer.as }};
	description "{{ ns.description }}";

	{% if (peer.disabled | default(false)) or (neighbor.disabled | default(false)) %}
	disabled;
	{% endif %}
	{% if ns.inet == "INET6" %}
	ipv6 {
		import table on;
		export table on;

		{% if ns.peer_type == "transit" %}
		import where import_transit_inet6_pref({{ ns.local_pref }});
		export where export_transit_inet6(false);
		{% elif ns.peer_type == "peer" %}
		import where import_peer_inet6_pref({{ ns.local_pref }});
		export where export_peer_inet6(false);
		{% elif ns.peer_type == "routeserver" %}
		import where import_ixp_rs_inet6_pref({{ ns.local_pref }});
		export where export_ixp_rs_inet6(false);
		{% elif ns.peer_type == "ixp_peer" %}
		import where import_ixp_inet6_pref({{ ns.local_pref }});
		export where export_ixp_inet6(false);
		{% elif ns.peer_type == "customer" %}
		import where import_customer_inet6_pref({{ ns.local_pref }});
		export where export_customer_inet6(false);
		{% else %}
		import none;
		export none;
		{% endif %}
	};
	{% elif ns.inet == "INET4" %}
	ipv4 {
		import table on;
		export table on;

		{% if ns.peer_type == "transit" %}
		import none;
		export none;
		{% elif ns.peer_type == "peer" %}
		import none;
		export none;
		{% elif ns.peer_type == "routeserver" %}
		import none;
		export none;
		{% elif ns.peer_type == "ixp_peer" %}
		import none;
		export none;
		{% elif ns.peer_type == "customer" %}
		import none;
		export none;
		{% else %}
		import none;
		export none;
		{% endif %}
	};
	{% endif %}
}

	{% endfor %}
{% endfor %}
